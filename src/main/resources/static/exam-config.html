<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>驾照考试管理系统 - 考试配置</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <style>
        /* 简单的淡入浮动动画 */
        @keyframes fadeUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        .animate-fade-up {
            animation: fadeUp 0.8s ease-out forwards;
        }
        /* 侧边栏菜单样式 */
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background-color: rgba(52, 199, 89, 0.1);
            color: #34C759;
        }
        .sidebar-item.active {
            background-color: rgba(52, 199, 89, 0.1);
            color: #34C759;
            border-right: 4px solid #34C759;
        }
        /* 表格样式 */
        .table-row {
            transition: all 0.2s ease;
        }
        .table-row:hover {
            background-color: rgba(52, 199, 89, 0.05);
        }
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-[#F5F7FA] min-h-screen font-sans overflow-hidden antialiased">
    <div class="flex h-screen">
        <!-- 左侧菜单栏 -->
        <aside class="w-64 bg-white shadow-md flex flex-col">
            <!-- 顶部Logo -->
            <div class="p-6 border-b border-gray-100 flex items-center">
                <span class="iconify w-8 h-8 text-[#2C5AA0]" data-icon="mingcute:shield-fill"></span>
                <span class="ml-3 text-xl font-bold text-[#333333]">驾考管理系统</span>
            </div>
            
            <!-- 菜单列表 -->
            <nav class="flex-1 p-4 space-y-1">
                <a href="#" class="sidebar-item flex items-center px-4 py-3 rounded-lg font-medium text-gray-600">
                    <span class="iconify w-5 h-5 mr-3" data-icon="mingcute:dashboard-line"></span>
                    仪表盘
                </a>
                <a href="user-management.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg font-medium text-gray-600">
                    <span class="iconify w-5 h-5 mr-3" data-icon="mingcute:user-3-line"></span>
                    用户管理
                </a>
                <a href="question-management.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg font-medium text-gray-600">
                    <span class="iconify w-5 h-5 mr-3" data-icon="mingcute:book-line"></span>
                    试题管理
                </a>
                <a href="exam-config.html" class="sidebar-item active flex items-center px-4 py-3 rounded-lg font-medium">
                    <span class="iconify w-5 h-5 mr-3" data-icon="mingcute:settings-3-line"></span>
                    考试配置
                </a>
                <a href="log-management.html" class="sidebar-item flex items-center px-4 py-3 rounded-lg font-medium text-gray-600">
                    <span class="iconify w-5 h-5 mr-3" data-icon="mingcute:clock-line"></span>
                    日志管理
                </a>
            </nav>
            
            <!-- 底部退出按钮 -->
            <div class="p-4 border-t border-gray-100">
                <a href="login.html" class="flex items-center px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-red-50 hover:text-red-500 transition-all" id="logoutBtn">
                    <span class="iconify w-5 h-5 mr-3" data-icon="mingcute:logout-box-line"></span>
                    退出登录
                </a>
            </div>
        </aside>
        
        <!-- 主内容区域 -->
        <main class="flex-1 overflow-y-auto">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm border-b border-gray-100">
                <div class="flex items-center justify-between h-16 px-6">
                    <!-- 左侧：菜单按钮和标题 -->
                    <div class="flex items-center">
                        <button class="mr-4 text-gray-500 hover:text-gray-700">
                            <span class="iconify w-5 h-5" data-icon="mingcute:menu-line"></span>
                        </button>
                        <h1 class="text-xl font-semibold text-[#333333]">驾考管理系统</h1>
                    </div>
                    
                    <!-- 右侧：搜索框、通知、用户信息 -->
                    <div class="flex items-center space-x-4">
                        <!-- 搜索框 -->
                        <div class="relative">
                            <input type="text" placeholder="搜索..." class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                            <span class="iconify absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" data-icon="mingcute:search-line"></span>
                        </div>
                        
                        <!-- 通知图标 -->
                        <button class="text-gray-500 hover:text-gray-700">
                            <span class="iconify w-5 h-5" data-icon="mingcute:bell-line"></span>
                        </button>
                        
                        <!-- 用户信息 -->
                        <div class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 px-3 py-1 rounded-lg transition-all">
                            <span class="iconify w-8 h-8 bg-[#34C759] text-white rounded-full flex items-center justify-center" data-icon="mingcute:user-3-fill"></span>
                            <span class="font-medium text-sm" id="currentUser">管理员</span>
                            <span class="iconify w-4 h-4 text-gray-400" data-icon="mingcute:arrow-down-s-line"></span>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- 内容区域 -->
            <div class="p-6">
                <!-- 页面标题和操作按钮 -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-[#333333]">考试配置</h2>
                        <p class="text-sm text-gray-500 mt-1">管理考试配置和生成考试题目</p>
                    </div>
                    <button class="bg-[#34C759] hover:bg-[#2DBE5F] text-white px-5 py-2 rounded-lg font-medium text-sm shadow-sm hover:shadow-md transition-all flex items-center" id="addExamBtn">
                        <span class="iconify w-4 h-4 mr-2" data-icon="mingcute:add-line"></span>
                        新增考试配置
                    </button>
                </div>
                
                <!-- 搜索和筛选区域 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                    <div class="flex flex-wrap gap-4">
                        <!-- 科目筛选 -->
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700 whitespace-nowrap">科目：</label>
                            <select id="searchSubject" class="px-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                                <option value="">全部科目</option>
                                <!-- 科目选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        
                        <!-- 考试名称搜索 -->
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700 whitespace-nowrap">考试名称：</label>
                            <input type="text" id="searchExamName" placeholder="输入考试名称" class="px-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                        </div>
                        
                        <!-- 搜索按钮 -->
                        <div class="flex items-center space-x-2 ml-auto">
                            <button class="bg-[#34C759] hover:bg-[#2DBE5F] text-white px-4 py-2 rounded-lg font-medium text-sm transition-all" id="searchBtn">
                                搜索
                            </button>
                            <button class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 px-4 py-2 rounded-lg font-medium text-sm transition-all" id="resetBtn">
                                重置
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 考试配置列表表格 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">考试名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">科目</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总题数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">合格分数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200" id="examTableBody">
                            <!-- 考试配置行将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页区域 -->
                <div class="flex items-center justify-between mt-6">
                    <div class="text-sm text-gray-500" id="paginationInfo">
                        显示 <span class="font-medium text-gray-700">1</span> 到 <span class="font-medium text-gray-700">5</span> 条，共 <span class="font-medium text-gray-700">1248</span> 条记录
                    </div>
                    <div class="flex items-center space-x-1" id="paginationControls">
                        <button class="px-3 py-1 rounded-lg border border-gray-200 bg-white text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="firstPageBtn">
                            <span class="iconify w-4 h-4" data-icon="mingcute:chevron-left-double-line"></span>
                        </button>
                        <button class="px-3 py-1 rounded-lg border border-gray-200 bg-white text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="prevPageBtn">
                            <span class="iconify w-4 h-4" data-icon="mingcute:chevron-left-line"></span>
                        </button>
                        <!-- 页码按钮将通过JavaScript动态生成 -->
                        <button class="px-3 py-1 rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50" id="nextPageBtn">
                            <span class="iconify w-4 h-4" data-icon="mingcute:chevron-right-line"></span>
                        </button>
                        <button class="px-3 py-1 rounded-lg border border-gray-200 bg-white text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="lastPageBtn">
                            <span class="iconify w-4 h-4" data-icon="mingcute:chevron-right-double-line"></span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 新增/编辑考试配置模态框 -->
    <div id="examModal" class="modal">
        <div class="modal-content animate-fade-up">
            <span class="close">&times;</span>
            <h2 class="text-xl font-bold text-[#333333] mb-6" id="modalTitle">新增考试配置</h2>
            <form id="examForm">
                <input type="hidden" id="examId" name="examId">
                
                <div class="mb-4">
                    <label for="modalExamName" class="block text-sm font-medium text-gray-700 mb-1">考试名称</label>
                    <input type="text" id="modalExamName" name="examName" placeholder="请输入考试名称" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                </div>
                
                <div class="mb-4">
                    <label for="modalSubject" class="block text-sm font-medium text-gray-700 mb-1">科目</label>
                    <select id="modalSubject" name="subjectId" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                        <!-- 科目选项将通过JavaScript动态加载 -->
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="modalTotalQuestions" class="block text-sm font-medium text-gray-700 mb-1">总题数</label>
                        <input type="number" id="modalTotalQuestions" name="totalQuestions" placeholder="请输入总题数" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                    </div>
                    
                    <div>
                        <label for="modalPassScore" class="block text-sm font-medium text-gray-700 mb-1">合格分数</label>
                        <input type="number" id="modalPassScore" name="passScore" placeholder="请输入合格分数" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                    </div>
                    
                    <div>
                        <label for="modalDuration" class="block text-sm font-medium text-gray-700 mb-1">考试时长（分钟）</label>
                        <input type="number" id="modalDuration" name="duration" placeholder="请输入考试时长" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="modalSingleChoiceCount" class="block text-sm font-medium text-gray-700 mb-1">单选题数量</label>
                        <input type="number" id="modalSingleChoiceCount" name="singleChoiceCount" placeholder="请输入单选题数量" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                    </div>
                    
                    <div>
                        <label for="modalMultipleChoiceCount" class="block text-sm font-medium text-gray-700 mb-1">多选题数量</label>
                        <input type="number" id="modalMultipleChoiceCount" name="multipleChoiceCount" placeholder="请输入多选题数量" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                    </div>
                    
                    <div>
                        <label for="modalTrueFalseCount" class="block text-sm font-medium text-gray-700 mb-1">判断题数量</label>
                        <input type="number" id="modalTrueFalseCount" name="trueFalseCount" placeholder="请输入判断题数量" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                    </div>
                </div>
                
                <!-- 每题分值设置 -->
                <div class="mb-6">
                    <label for="modalScorePerQuestion" class="block text-sm font-medium text-gray-700 mb-1">每题分值</label>
                    <input type="number" id="modalScorePerQuestion" name="scorePerQuestion" placeholder="请输入每题分值" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#34C759]/50 focus:border-[#34C759] text-sm">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 px-4 py-2 rounded-lg font-medium text-sm transition-all" id="cancelBtn">
                        取消
                    </button>
                    <button type="submit" class="bg-[#34C759] hover:bg-[#2DBE5F] text-white px-4 py-2 rounded-lg font-medium text-sm transition-all">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 查看考试题目模态框 -->
    <div id="viewQuestionsModal" class="modal">
        <div class="modal-content animate-fade-up" style="max-width: 800px; margin: 5% auto; max-height: 80vh; overflow-y: auto;">
            <span class="close">&times;</span>
            <h2 class="text-xl font-bold text-[#333333] mb-6" id="viewQuestionsModalTitle">查看考试题目</h2>
            <div id="examQuestionsContainer">
                <!-- 考试题目将通过JavaScript动态生成 -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 px-4 py-2 rounded-lg font-medium text-sm transition-all" onclick="closeViewQuestionsModal()">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <script>
        // 当前页码和每页条数
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        
        // 模态框相关元素
        const modal = document.getElementById('examModal');
        const closeModal = document.querySelector('.close');
        const addExamBtn = document.getElementById('addExamBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const examForm = document.getElementById('examForm');
        const modalTitle = document.getElementById('modalTitle');
        
        // 搜索和筛选相关元素
        const searchSubject = document.getElementById('searchSubject');
        const searchExamName = document.getElementById('searchExamName');
        const searchBtn = document.getElementById('searchBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        // 分页相关元素
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');
        const paginationInfo = document.getElementById('paginationInfo');
        
        // 考试配置表格相关元素
        const examTableBody = document.getElementById('examTableBody');
        
        // 退出登录按钮
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUser = document.getElementById('currentUser');
        
        // 存储科目数据
        let subjects = [];
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            checkLoginStatus();
            // 加载科目数据
            loadSubjects();
            // 加载考试配置列表
            loadExams();
            
            // 绑定事件
            bindEvents();
        });
        
        // 检查登录状态
        function checkLoginStatus() {
            const user = localStorage.getItem('user');
            if (user) {
                const userObj = JSON.parse(user);
                currentUser.textContent = userObj.realName;
            } else {
                // 未登录，跳转到登录页面
                window.location.href = '/login.html';
            }
        }
        
        // 绑定事件
        function bindEvents() {
            // 新增考试配置按钮点击事件
            addExamBtn.addEventListener('click', function() {
                openModal();
            });
            
            // 关闭模态框
            closeModal.addEventListener('click', function() {
                closeModalFunc();
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    closeModalFunc();
                }
            });
            
            // 取消按钮点击事件
            cancelBtn.addEventListener('click', function() {
                closeModalFunc();
            });
            
            // 表单提交事件
            examForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveExam();
            });
            
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', function() {
                currentPage = 1;
                loadExams();
            });
            
            // 重置按钮点击事件
            resetBtn.addEventListener('click', function() {
                searchSubject.value = '';
                searchExamName.value = '';
                currentPage = 1;
                loadExams();
            });
            
            // 分页按钮点击事件
            firstPageBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage = 1;
                    loadExams();
                }
            });
            
            prevPageBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadExams();
                }
            });
            
            nextPageBtn.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadExams();
                }
            });
            
            lastPageBtn.addEventListener('click', function() {
                currentPage = totalPages;
                loadExams();
            });
            
            // 退出登录按钮点击事件
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            });
        }
        
        // 打开模态框
        function openModal(exam = null) {
            // 清空表单
            examForm.reset();
            document.getElementById('examId').value = '';
            
            if (exam) {
                // 编辑模式
                modalTitle.textContent = '编辑考试配置';
                
                // 填充表单数据
                document.getElementById('examId').value = exam.examId;
                document.getElementById('modalExamName').value = exam.examName;
                document.getElementById('modalSubject').value = exam.subjectId;
                document.getElementById('modalTotalQuestions').value = exam.questionCount;
                document.getElementById('modalPassScore').value = exam.passScore;
                document.getElementById('modalDuration').value = exam.duration;
                document.getElementById('modalSingleChoiceCount').value = exam.singleChoiceCount;
                document.getElementById('modalMultipleChoiceCount').value = exam.multipleChoiceCount;
                document.getElementById('modalTrueFalseCount').value = exam.trueFalseCount;
                
                // 填充每题分值
                document.getElementById('modalScorePerQuestion').value = exam.scorePerQuestion || '';
            } else {
                // 新增模式
                modalTitle.textContent = '新增考试配置';
            }
            
            // 显示模态框
            modal.style.display = 'block';
        }
        
        // 关闭模态框
        function closeModalFunc() {
            modal.style.display = 'none';
        }
        
        // 查看题目模态框相关元素
        const viewQuestionsModal = document.getElementById('viewQuestionsModal');
        const viewQuestionsClose = viewQuestionsModal.querySelector('.close');
        
        // 关闭查看题目模态框
        function closeViewQuestionsModal() {
            viewQuestionsModal.style.display = 'none';
        }
        
        // 绑定查看题目模态框关闭事件
        viewQuestionsClose.addEventListener('click', closeViewQuestionsModal);
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target == viewQuestionsModal) {
                closeViewQuestionsModal();
            }
        });
        
        // 查看考试题目
        function viewExamQuestions(examId) {
            // 设置模态框标题
            document.getElementById('viewQuestionsModalTitle').textContent = `查看考试题目 - ${examId}`;
            
            // 发送请求获取考试题目
            fetch(`/api/exam/${examId}/questions`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 渲染考试题目
                        renderExamQuestions(data.data);
                        // 显示模态框
                        viewQuestionsModal.style.display = 'block';
                    } else {
                        alert(data.message || '获取考试题目失败');
                    }
                })
                .catch(error => {
                    console.error('获取考试题目失败:', error);
                    alert('获取考试题目失败，请稍后重试');
                });
        }
        
        // 渲染考试题目
        function renderExamQuestions(questions) {
            const container = document.getElementById('examQuestionsContainer');
            let html = '';
            
            questions.forEach((question, index) => {
                try {
                    // 生成题目HTML框架
                    html += `
                        <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-100">
                            <div class="flex items-start mb-3">
                                <div class="flex items-center justify-center w-8 h-8 mr-3 text-sm font-medium text-white bg-blue-500 rounded-full">
                                    ${index + 1}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900 mb-2">${question.content}</div>
                                    ${question.imageUrl ? `<img src="${question.imageUrl}" alt="题目图片" class="mb-3 max-w-full h-auto rounded">` : ''}
                                    <div class="text-sm text-gray-500 mb-1">题型：${question.typeName} | 分值：${question.score}分</div>`;
                    
                    // 解析选项JSON并生成选项HTML
                    let optionsHtml = '';
                    try {
                        // 声明options变量
                        let options;
                        // 检查optionsJson类型，确保它是字符串
                        let optionsJson = question.optionsJson;
                        if (typeof optionsJson === 'object') {
                            // 如果已经是对象，直接使用
                            options = optionsJson;
                        } else {
                            // 否则解析JSON字符串
                            options = JSON.parse(optionsJson);
                        }
                        
                        // 生成选项HTML
                        options.forEach(option => {
                            // 为判断题的特殊选项代码添加特殊样式
                            const isSpecialCode = option.optionCode === '√' || option.optionCode === '×';
                            const optionCodeClass = isSpecialCode ? 'w-8 bg-yellow-100 text-yellow-800' : 'w-6 bg-gray-100 text-gray-800';
                            
                            optionsHtml += `
                                <div class="flex items-start mb-2">
                                    <span class="inline-flex items-center justify-center mr-2 text-sm font-medium rounded-full ${optionCodeClass}">
                                        ${option.optionCode || ' '}
                                    </span>
                                    <span>${option.content || '无选项内容'}</span>
                                </div>
                            `;
                        });
                    } catch (jsonError) {
                        console.error(`解析选项JSON失败 - 题目ID: ${question.questionId}`, jsonError);
                        optionsHtml = `<div class="text-red-500 text-sm mb-3">选项解析错误: ${jsonError.message}</div>`;
                    }
                    
                    // 继续生成题目HTML的剩余部分
                    html += `
                                    <div class="mb-3">${optionsHtml}</div>
                                    <div class="flex items-center text-sm">
                                        <span class="font-medium text-gray-700 mr-2">正确答案：</span>
                                        <span class="px-2 py-0.5 bg-green-100 text-green-800 rounded">${question.correctAnswer || '未设置'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`渲染题目失败 - 索引: ${index}`, error);
                    html += `
                        <div class="mb-8 p-4 bg-red-50 rounded-lg border border-red-100">
                            <div class="font-medium text-red-900 mb-2">题目渲染错误</div>
                            <div class="text-sm text-red-600">错误信息: ${error.message}</div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }
        
        // 加载科目列表
        function loadSubjects() {
            fetch('/api/question/subjects')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        subjects = data.data;
                        renderSubjectOptions();
                    } else {
                        alert(data.message || '获取科目列表失败');
                    }
                })
                .catch(error => {
                    console.error('获取科目列表失败:', error);
                    alert('获取科目列表失败，请稍后重试');
                });
        }
        
        // 渲染科目选项
        function renderSubjectOptions() {
            const subjectSelectors = [
                document.getElementById('searchSubject'),
                document.getElementById('modalSubject')
            ];
            
            subjectSelectors.forEach(selector => {
                if (selector) {
                    // 清空现有选项（保留默认选项）
                    const defaultOption = selector.querySelector('option[value=""]');
                    selector.innerHTML = defaultOption ? defaultOption.outerHTML : '';
                    
                    // 添加科目选项
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.subjectId;
                        option.textContent = subject.subjectName;
                        selector.appendChild(option);
                    });
                }
            });
        }
        
        // 加载考试配置列表
        function loadExams() {
            // 构建查询参数
            const params = new URLSearchParams();
            params.append('page', currentPage);
            params.append('size', pageSize);
            
            // 添加搜索条件
            if (searchSubject.value) {
                params.append('subjectId', searchSubject.value);
            }
            if (searchExamName.value) {
                params.append('examName', searchExamName.value);
            }
            
            // 发送请求
            fetch(`/api/exam/list?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderExams(data.data);
                        // 分页信息直接从返回结果中获取，而不是从data.data中获取
                        renderPagination({ 
                            totalElements: data.total, 
                            totalPages: data.pages 
                        });
                    } else {
                        alert(data.message || '获取考试配置列表失败');
                    }
                })
                .catch(error => {
                    console.error('获取考试配置列表失败:', error);
                    alert('获取考试配置列表失败，请稍后重试');
                });
        }
        
        // 渲染考试配置列表
        function renderExams(exams) {
            let html = '';
            
            exams.forEach(exam => {
                // 格式化创建时间
                const createTime = new Date(exam.createTime).toLocaleString();
                
                html += `
                    <tr class="table-row">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${exam.examId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-[#333333]">${exam.examName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${exam.subjectName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${exam.totalQuestions}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${exam.passScore}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${createTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <div class="flex items-center space-x-2">
                                <button class="bg-purple-50 hover:bg-purple-100 text-purple-700 px-3 py-1 rounded-lg text-xs font-medium transition-colors" onclick="viewExamQuestions(${exam.examId})">查看题目</button>
                                <button class="bg-red-50 hover:bg-red-100 text-red-700 px-3 py-1 rounded-lg text-xs font-medium transition-colors" onclick="deleteExam(${exam.examId})">删除</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            examTableBody.innerHTML = html;
        }
        
        // 渲染分页信息
        function renderPagination(pageData) {
            const totalElements = pageData.totalElements;
            totalPages = pageData.totalPages;
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalElements);
            
            // 更新分页信息
            paginationInfo.innerHTML = `
                显示 <span class="font-medium text-gray-700">${start}</span> 到 <span class="font-medium text-gray-700">${end}</span> 条，共 <span class="font-medium text-gray-700">${totalElements}</span> 条记录
            `;
            
            // 更新分页按钮状态
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;
        }
        
        // 保存考试配置
        function saveExam() {
            // 获取表单数据
            const formData = new FormData(examForm);
            const examData = {};
            formData.forEach((value, key) => {
                examData[key] = value;
            });
            
            // 构建请求
            const url = examData.examId ? `/api/exam/${examData.examId}` : '/api/exam';
            const method = examData.examId ? 'PUT' : 'POST';
            
            // 计算总题数
            const singleChoiceCount = parseInt(examData.singleChoiceCount) || 0;
            const multipleChoiceCount = parseInt(examData.multipleChoiceCount) || 0;
            const trueFalseCount = parseInt(examData.trueFalseCount) || 0;
            const totalQuestions = singleChoiceCount + multipleChoiceCount + trueFalseCount;
            
            // 处理表单数据，确保字段名正确映射
            const scorePerQuestion = examData.scorePerQuestion ? parseInt(examData.scorePerQuestion) : 2; // 默认每题2分
            const totalScore = totalQuestions * scorePerQuestion;
            
            const processedData = {
                examName: examData.examName,
                subjectId: parseInt(examData.subjectId),
                duration: parseInt(examData.duration),
                questionCount: totalQuestions,
                totalScore: totalScore,
                passScore: parseInt(examData.passScore),
                singleChoiceCount: singleChoiceCount,
                multipleChoiceCount: multipleChoiceCount,
                trueFalseCount: trueFalseCount,
                // 每题分值
                scorePerQuestion: scorePerQuestion
            };
            
            // 获取当前用户信息，添加X-Admin-Id请求头
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // 发送请求
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Id': user.id || ''
                },
                body: JSON.stringify(processedData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 保存成功，关闭模态框并刷新列表
                    closeModalFunc();
                    loadExams();
                    
                    // 提示用户生成题目
                    if (method === 'POST') {
                        // 新增考试配置成功后，提示用户生成题目
                        const examId = data.data.examId;
                        if (confirm('考试配置创建成功，是否立即生成题目？')) {
                            generateExam(examId);
                        }
                    } else {
                        alert(data.message || '保存成功');
                    }
                } else {
                    alert(data.message || '保存失败');
                }
            })
            .catch(error => {
                console.error('保存考试配置失败:', error);
                alert('保存考试配置失败，请稍后重试');
            });
        }
        
        // 编辑考试配置
        function editExam(exam) {
            openModal(exam);
        }
        
        // 生成考试题目
        function generateExam(examId) {
            if (confirm('确定要生成该考试的题目吗？')) {
                // 获取当前用户信息，添加X-Admin-Id请求头
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                fetch(`/api/exam/${examId}/generate`, {
                    method: 'POST',
                    headers: {
                        'X-Admin-Id': user.id || ''
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 生成成功，刷新列表
                        loadExams();
                        alert(data.message || '考试题目生成成功');
                    } else {
                        alert(data.message || '考试题目生成失败');
                    }
                })
                .catch(error => {
                    console.error('生成考试题目失败:', error);
                    alert('生成考试题目失败，请稍后重试');
                });
            }
        }
        
        // 删除考试配置
        function deleteExam(examId) {
            if (confirm('确定要删除该考试配置吗？')) {
                // 获取当前用户信息，添加X-Admin-Id请求头
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                fetch(`/api/exam/${examId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Admin-Id': user.id || ''
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 删除成功，刷新列表
                        loadExams();
                        alert(data.message || '删除成功');
                    } else {
                        alert(data.message || '删除失败');
                    }
                })
                .catch(error => {
                    console.error('删除考试配置失败:', error);
                    alert('删除考试配置失败，请稍后重试');
                });
            }
        }
    </script>
</body>
</html>